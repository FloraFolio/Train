# Flora Folio 照片处理流程

本文档描述了从用户拍摄/选择照片，到调用 Gemini AI 进行识别，再到更新植物信息的完整流程。

## 整体流程图

```
┌─────────────────┐
│  用户拍摄/选择照片  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 在本地存储照片文件  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│ 创建照片记录(status=ANALYZING)    │
│ 调用 addPlantPhoto 接口          │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  启动AI分析任务 (异步执行)         │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  准备照片数据，调用 Gemini API     │
└────────────────┬────────────────┘
                 │
                 ▼
     ┌───────────┴───────────┐
     │                       │
     ▼                       ▼
┌────────────┐        ┌─────────────┐
│ AI识别成功  │        │  AI识别失败  │
└──────┬─────┘        └───────┬─────┘
       │                      │
       ▼                      ▼
┌────────────────┐    ┌─────────────────┐
│提取植物种类和描述│    │  记录失败原因    │
└────────┬───────┘    └────────┬────────┘
         │                     │
         └──────────┬──────────┘
                    │
                    ▼
┌──────────────────────────────────────┐
│ 更新照片记录 (status=SUCCESS/FAILED)   │
│ 调用 updatePhotoAnalysisResult 接口    │
└─────────────────┬────────────────────┘
                  │
                  ▼
┌──────────────────────────────────────┐
│        通知UI更新展示                  │
└──────────────────────────────────────┘
```

## 详细步骤说明

### 1. 用户拍摄/选择照片

- 用户通过应用界面拍摄新照片或从相册选择已有照片
- 应用获取到照片的 File 对象

### 2. 本地存储照片文件

- 生成唯一的照片ID (UUID)
- 将照片保存到应用文档目录下的指定位置
- 获取照片的存储路径

### 3. 创建照片记录

- 调用 `addPlantPhoto` 接口
- 设置初始状态为 `PhotoStatus.ANALYZING`
- 存储照片基本信息到数据库
- 记录创建时间和其他元数据

### 4. 启动AI分析任务

- 创建异步任务或使用隔离区 (isolate) 进行处理
- 加载照片数据，准备用于AI分析
- 确保分析过程不会阻塞UI线程

### 5. 调用 Gemini API

- 准备API请求参数
- 设置合适的模型和提示词 (prompt)
- 发送照片数据到 Gemini API
- 等待API响应

### 6. 处理AI识别结果

**成功情况**:
- 从API响应中提取植物种类信息
- 获取植物的学名和详细描述
- 如有必要，添加新的植物种类到 `species` 表

**失败情况**:
- 记录错误原因
- 准备用户友好的错误信息

### 7. 更新照片记录

- 调用 `updatePhotoAnalysisResult` 接口
- 根据AI识别结果更新照片状态:
  - 成功: 设置 `status = PhotoStatus.SUCCESS`，更新 `species_id` 和 `description`
  - 失败: 设置 `status = PhotoStatus.FAILED`，添加错误信息到元数据
- 更新 `updated_at` 时间戳

### 8. 通知UI更新

- 使用状态管理系统通知UI组件
- 根据照片的新状态更新界面显示


